<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slime Mold Simulation</title>
</head>
<body style="margin: 0;">

    <canvas id="myCanvas"></canvas>

    <script>
        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');
        const cellSize = 8;

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;



        class Grid {
            constructor(gridX, gridY, gridSize) {
                this.xSize = gridX;
                this.ySize = gridY;
                this.cellSize = gridSize;
                this.cells = [];

                for (let i = 0; i < this.ySize; i++) {
                    let subCells = [];
                    for (let g = 0; g < this.xSize; g++) {
                        subCells.push(0);
                    }
                    this.cells.push(subCells);
                }
            }

            reloadCells() {
                this.diffuse();

                for (let i = 0; i < this.cells.length; i++) {
                    for (let g = 0; g < this.cells[i].length; g++) {
                        this.updateCell(g, i, this.cells[i][g]);
                    }
                }
            }

            updateCell(x, y, cellValue) {
                ctx.fillStyle = `rgb(
                    ${0}, 
                    ${cellValue}, 
                    ${cellValue}
                )`

                ctx.fillRect(x*this.cellSize, y*this.cellSize, this.cellSize, this.cellSize);
            }

            diffuse() {
                // let tempGrid = new Grid(this.xSize, this.ySize, this.cellSize);

                // for (let i = 1; i < this.cells.length - 1; i++) {
                //     for (let g = 1; g < this.cells[i].length - 1; g++) {
                        

                //         let avgSpores = 0;

                //         for (let y = -1; y <= 1; y++) {
                //             for (let x = -1; x <= 1; x++) {
                //                 avgSpores += this.cells[i + y][g + x]/9;
                //             }
                //         }

                //         tempGrid.cells[i][g] = avgSpores;
                //         tempGrid.cells[i][g] /= 1.05;
                //     }
                // }


                for (let i = 1; i < this.cells.length - 1; i++) {
                    for (let g = 1; g < this.cells[i].length - 1; g++) {
                       this.cells[i][g] /= 1.01;
                    }
                }
            }
        }



        class Spore {
            constructor(startVx, startVy, startPosX, startPosY, cellGrid) {
                this.vX = startVx;
                this.vY = startVy;
                this.xPos = startPosX;
                this.yPos = startPosY;
                this.grid = cellGrid;
            }

            spreadSpores() {
                this.grid.cells[Math.round(this.yPos)][Math.round(this.xPos)] += 255;
            }

            move(time) {
                let currentIndex = 0;
                const interval = setInterval(() => {
                    if (currentIndex < time) {
                        if ((Math.round(this.xPos + this.vX) >= this.grid.xSize - 1) || (Math.round(this.xPos + this.vX) <= 0)) {
                            this.vX *= -1;
                        } else if ((Math.round(this.yPos + this.vY) >= this.grid.ySize - 1) || (Math.round(this.yPos + this.vY) <= 0)) {
                            this.vY *= -1;
                        }

                        this.xPos += this.vX;
                        this.yPos += this.vY;

                        this.spreadSpores();
                        this.grid.reloadCells();

                        currentIndex++;
                    } else {
                        clearInterval(interval);
                    }
                }, 0);
            }
        }


        
        const randInt = (max) => {
            return Math.floor(Math.random() * max)
        }

        const init = () => {

            const grid = new Grid(64, 64, 16);
            grid.reloadCells();

            let spores = [];

            for (let i = 0; i < 10; i++) {
                let vx = randInt(10)/10
                spores.push(new Spore(vx, 1-vx, randInt(grid.xSize - 5) + 2, randInt(grid.ySize - 5) + 2, grid));
            }

            spores.forEach(element => {
                element.spreadSpores();
                element.move(10000);
            });

        }

        init();
    </script>
</body>
</html>